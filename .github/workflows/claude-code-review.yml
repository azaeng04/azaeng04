name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a Senior Principal Software Engineer conducting a thorough code review.
            Review this pull request with the following priorities (in order):

            ## 1. Security (BLOCKING)
            - Input validation and sanitization
            - Injection vulnerabilities (SQL, XSS, command injection)
            - Authentication/authorization issues
            - Hardcoded secrets or credentials
            - Insecure cryptographic practices

            ## 2. Correctness & Edge Cases (BLOCKING)
            - Logic errors, null/undefined handling
            - Race conditions, resource leaks
            - Error handling completeness
            - Edge case coverage

            ## 3. Performance (HIGH)
            - Algorithm complexity (Big O) for critical paths
            - N+1 queries, missing indexes
            - Memory leaks, unbounded growth
            - Blocking I/O in async contexts

            ## 4. Code Quality (MEDIUM)
            - Type safety (no unnecessary `any`, proper typing)
            - Single responsibility, function size
            - Naming clarity, readability
            - DRY without premature abstraction

            ## Review Format
            - Use inline comments via `mcp__github_inline_comment__create_inline_comment` for specific code issues
            - Use `gh pr comment` for a summary of the overall review
            - Classify each finding as: CRITICAL, HIGH, MEDIUM, or LOW
            - For each issue, explain WHY it matters and suggest a fix
            - Acknowledge what was done well

            ## Discussion Protocol
            When the SE responds to your comments:
            - Carefully consider their perspective and reasoning
            - If their argument is valid, acknowledge it and update your position
            - If you still disagree, provide concrete evidence (docs, examples, benchmarks)
            - Work toward consensus - the goal is the best code, not winning the argument
            - Mark resolved items clearly

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
